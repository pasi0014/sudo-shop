{%- comment -%}
  Featured Collection Section - Terminal CLI Design System
{%- endcomment -%}

{% assign collection = collections[section.settings.collection] %}

<div class="section featured-collection-section">
  <div class="container">
    <div class="terminal-window">
      <div class="terminal-header-bar">
        <div class="terminal-window-controls">
          <div class="terminal-control close" aria-hidden="true"></div>
          <div class="terminal-control minimize" aria-hidden="true"></div>
          <div class="terminal-control maximize" aria-hidden="true"></div>
        </div>
        <p class="terminal-window-title">~/products/{{ collection.handle | default: 'featured' }}</p>
      </div>
      <div class="terminal-window-content">
        <div class="collection-header">
          {% render 'command-prompt', user: 'sudo', directory: '~/products', command: 'ls -la ' | append: collection.handle %}
          
          {% if section.settings.heading != blank %}
            <h2 class="collection-title">{{ section.settings.heading }}</h2>
          {% else %}
            <h2 class="collection-title">{{ collection.title }}</h2>
          {% endif %}
          
          {% if section.settings.description != blank %}
            <p class="collection-description">{{ section.settings.description }}</p>
          {% elsif collection.description != blank %}
            <p class="collection-description">{{ collection.description }}</p>
          {% endif %}
        </div>

        {%- if collection.products_count > 0 -%}
          <ul class="product-grid grid-{{ section.settings.columns }}">
            {%- for product in collection.products limit: section.settings.products_to_show -%}
              <li class="product-card fade-in" style="animation-delay: {{ forloop.index | times: 100 }}ms">
                <div class="product-card-inner">
                  <div class="product-card-image-wrapper">
                    <a href="{{ product.url }}" class="product-card-link">
                      {% if product.featured_media %}
                        <img 
                          srcset="
                            {{ product.featured_media | image_url: width: 400 }} 400w,
                            {{ product.featured_media | image_url: width: 600 }} 600w,
                            {{ product.featured_media | image_url: width: 800 }} 800w
                          "
                          src="{{ product.featured_media | image_url: width: 600 }}"
                          alt="{{ product.featured_media.alt | escape }}"
                          width="{{ product.featured_media.width }}"
                          height="{{ product.featured_media.height }}"
                          loading="lazy"
                          class="product-card-img"
                        >
                      {% else %}
                        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      {% endif %}
                    </a>
                    
                    {% if product.available == false %}
                      <span class="badge badge-error">SOLD OUT</span>
                    {% elsif product.compare_at_price > product.price %}
                      <span class="badge badge-warning">ON SALE</span>
                    {% endif %}
                  </div>

                  <div class="product-card-content">
                    <h3 class="product-card-title">
                      <a href="{{ product.url }}" class="link">{{ product.title }}</a>
                    </h3>

                    <div class="product-card-price">
                      {% if product.compare_at_price > product.price %}
                        <span class="price-original">
                          {{ product.compare_at_price | money }}
                        </span>
                        <span class="price-sale">
                          {{ product.price | money }}
                        </span>
                      {% else %}
                        <span class="price">
                          {{ product.price | money }}
                        </span>
                      {% endif %}
                    </div>

                    {% if product.variants.size > 1 %}
                      <div class="product-variants">
                        <span class="text-muted small">{{ product.variants.size }} variants</span>
                      </div>
                    {% endif %}

                    <div class="product-card-actions">
                      {% render 'terminal-button', 
                        text: 'Add to Cart', 
                        type: 'secondary', 
                        type_attr: 'button',
                        class: 'add-to-cart-btn',
                        onclick: 'addToCart(\'' | append: product.selected_or_first_available_variant.id | append: '\')',
                        disabled: product.available == false
                      %}
                    </div>
                  </div>
                </div>
              </li>
            {%- endfor -%}
          </ul>
        {%- else -%}
          <div class="terminal-output">
            <p class="text-muted">No products found in this collection.</p>
          </div>
        {%- endif -%}

        {%- if section.settings.show_view_all and collection.all_products_count > section.settings.products_to_show -%}
          <div class="view-all-wrapper">
            {% render 'terminal-button', 
              text: 'View All Products', 
              type: 'cta', 
              url: collection.url 
            %}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Featured collection",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Collection"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4,
      "label": "Products to show"
    },
    {
      "type": "range",
      "id": "columns",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 4,
      "label": "Columns"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "default": true,
      "label": "Show \"View all\" link"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": false,
      "label": "Show secondary image on hover"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    }
  ],
  "presets": [
    {
      "name": "Featured collection"
    }
  ]
}
{% endschema %}

{% stylesheet %}
.collection-header {
  margin-bottom: var(--spacing-32);
}

.collection-title {
  font-size: 2rem;
  margin: var(--spacing-16) 0;
  color: var(--accent-primary);
}

.collection-description {
  color: var(--text-secondary);
  margin: 0;
}

.product-grid {
  display: grid;
  gap: var(--spacing-24);
  margin-bottom: var(--spacing-32);
}

.grid-2 {
  grid-template-columns: repeat(2, 1fr);
}

.grid-3 {
  grid-template-columns: repeat(3, 1fr);
}

.grid-4 {
  grid-template-columns: repeat(4, 1fr);
}

@media (max-width: 768px) {
  .grid-2,
  .grid-3,
  .grid-4 {
    grid-template-columns: 1fr;
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  .grid-4 {
    grid-template-columns: repeat(2, 1fr);
  }
}

.product-card-image-wrapper {
  position: relative;
  margin-bottom: var(--spacing-16);
}

.badge {
  position: absolute;
  top: var(--spacing-12);
  right: var(--spacing-12);
  z-index: 10;
}

.product-card-link {
  display: block;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  overflow: hidden;
}

.product-card-img {
  width: 100%;
  height: auto;
  display: block;
  transition: transform 0.3s ease;
}

.product-card:hover .product-card-img {
  transform: scale(1.05);
}

.product-card-title {
  font-size: 1rem;
  margin: 0 0 var(--spacing-8) 0;
  font-weight: 500;
}

.product-card-price {
  margin-bottom: var(--spacing-8);
  font-size: 1.125rem;
}

.price-original {
  text-decoration: line-through;
  color: var(--text-secondary);
  margin-right: var(--spacing-8);
}

.price-sale,
.price {
  color: var(--accent-primary);
  font-weight: 600;
}

.product-variants {
  margin-bottom: var(--spacing-16);
}

.product-card-actions {
  margin-top: auto;
}

.add-to-cart-btn {
  width: 100%;
}

.add-to-cart-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.view-all-wrapper {
  text-align: center;
}

@media (max-width: 750px) {
  .collection-title {
    font-size: 1.5rem;
  }
}
{% endstylesheet %}

{% javascript %}
function addToCart(productId) {
  fetch(`${window.routes.cart_add_url}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({
      items: [{
        id: productId,
        quantity: 1
      }]
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status) {
      alert('Error: ' + data.description);
    } else {
      const button = document.querySelector(`button[onclick*="${productId}"]`);
      if (button) {
        const originalText = button.textContent;
        button.textContent = 'Added!';
        button.disabled = true;
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 2000);
      }
      
      const cartCount = document.querySelector('.cart-count-bubble span');
      if (cartCount) {
        const currentCount = parseInt(cartCount.textContent);
        cartCount.textContent = currentCount + 1;
      }
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error adding to cart');
  });
}
{% endjavascript %}
